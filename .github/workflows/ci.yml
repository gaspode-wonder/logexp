# filename: .github/workflows/ci.yml
name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
            - develop

jobs:
    lint-and-tests:
        name: Lint + Unit Tests + Config Schema
        runs-on: ubuntu-latest

        env:
            PYTHON_VERSION: "3.10.14"
            DATABASE_URL: ""
            SQLALCHEMY_DATABASE_URI: "sqlite:///:memory:"
            LOCAL_TIMEZONE: "UTC"
            GEIGER_THRESHOLD: "0.1"
            START_POLLER: "False"
            LOGEXP_NODE_ID: "ci-node"
            TELEMETRY_ENABLED: "True"
            TELEMETRY_INTERVAL_SECONDS: "30"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Clean workspace
              run: git clean -xfd

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "${{ env.PYTHON_VERSION }}"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .
                  pip install -r requirements.txt

            - name: Lint (ruff)
              run: ruff check .

            - name: Run unit tests (pytest)
              run: pytest -vv

    docker-boot:
        name: Docker Build + App Boot Smoke Test
        runs-on: ubuntu-latest
        needs: lint-and-tests

        env:
            DATABASE_URL: "postgresql://logexp:logexp@postgres:5432/logexp"
            SQLALCHEMY_DATABASE_URI: "postgresql://logexp:logexp@postgres:5432/logexp"
            LOCAL_TIMEZONE: "UTC"
            GEIGER_THRESHOLD: "0.1"
            START_POLLER: "False"
            LOGEXP_NODE_ID: "ci-node"
            TELEMETRY_ENABLED: "True"
            TELEMETRY_INTERVAL_SECONDS: "30"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Clean workspace
              run: git clean -xfd

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10.14"

            - name: Build Docker image
              run: docker build -t logexp:test -f beamfoundry/Dockerfile .

            - name: Install package for smoketest
              run: pip install .

            - name: Ensure create_app() boots inside container
              run: |
                  docker run --rm \
                    -e DATABASE_URL=${DATABASE_URL} \
                    -e SQLALCHEMY_DATABASE_URI=${SQLALCHEMY_DATABASE_URI} \
                    -e LOCAL_TIMEZONE=${LOCAL_TIMEZONE} \
                    -e GEIGER_THRESHOLD=${GEIGER_THRESHOLD} \
                    -e START_POLLER=${START_POLLER} \
                    -e LOGEXP_NODE_ID=${LOGEXP_NODE_ID} \
                    -e TELEMETRY_ENABLED=${TELEMETRY_ENABLED} \
                    -e TELEMETRY_INTERVAL_SECONDS=${TELEMETRY_INTERVAL_SECONDS} \
                    logexp:test \
                    flask --app beamfoundry:create_app routes

    postgres-migrations:
        name: Postgres 18 Migrations + DB Connectivity
        runs-on: ubuntu-latest
        needs: lint-and-tests

        services:
            postgres:
                image: postgres:18
                env:
                    POSTGRES_USER: logexp
                    POSTGRES_PASSWORD: logexp
                    POSTGRES_DB: logexp
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready -U logexp -d logexp"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        env:
            DATABASE_URL: "postgresql://logexp:logexp@localhost:5432/logexp"
            SQLALCHEMY_DATABASE_URI: "postgresql://logexp:logexp@localhost:5432/logexp"
            LOCAL_TIMEZONE: "UTC"
            GEIGER_THRESHOLD: "0.1"
            START_POLLER: "False"
            LOGEXP_NODE_ID: "ci-node"
            TELEMETRY_ENABLED: "True"
            TELEMETRY_INTERVAL_SECONDS: "30"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Clean workspace
              run: git clean -xfd

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10.14"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .
                  pip install -r requirements.txt

            - name: Wait for Postgres
              run: |
                  for i in {1..30}; do
                    if pg_isready -h localhost -p 5432 -U logexp -d logexp; then
                      exit 0
                    fi
                    sleep 2
                  done
                  exit 1

            - name: Run migrations
              run: flask --app beamfoundry:create_app db upgrade

            - name: Smoke test DB connectivity
              run: |
                  python - << 'EOF'
                  from beamfoundry import create_app
                  app = create_app()
                  with app.app_context():
                      from beamfoundry.extensions import db
                      conn = db.engine.connect()
                      conn.close()
                  EOF
