name: Autoâ€‘Label Pull Requests

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  apply-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Apply labels based on file paths
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Fetch changed files
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number }
            );

            const labelsToAdd = new Set();

            for (const file of files) {
              const path = file.filename;

              // Backend / ingestion / poller
              if (path.startsWith("logexp/app/poller") ||
                  path.startsWith("logexp/app/ingestion") ||
                  path.startsWith("logexp/app/geiger")) {
                labelsToAdd.add("backend");
              }

              // Config system
              if (path.startsWith("logexp/app/config")) {
                labelsToAdd.add("architecture");
                labelsToAdd.add("environment");
              }

              // Analytics
              if (path.startsWith("logexp/app/analytics")) {
                labelsToAdd.add("backend");
                labelsToAdd.add("observability");
              }

              // Tests
              if (path.startsWith("tests/")) {
                labelsToAdd.add("testing");
              }

              // Docs
              if (path.endsWith(".md")) {
                labelsToAdd.add("documentation");
              }

              // CI/CD
              if (path.startsWith(".github/workflows")) {
                labelsToAdd.add("CI/CD");
              }
            }

            if (labelsToAdd.size > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: Array.from(labelsToAdd),
              });
            }
