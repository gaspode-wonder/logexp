{% extends "docs/base_docs.html" %}

{% block title %}Timezone Policy - LogExp{% endblock %}

{% block content %}
  <h1>Timezone Policy</h1>
  <p>LogExp normalizes all timestamps to <strong>UTC</strong> before storing and emitting them.</p>
  <!-- Troubleshooting + FAQ sections go here -->
{% endblock %}

{% block content %}
  <h1>Timezone Policy</h1>
  <p>LogExp normalizes all timestamps to <strong>UTC</strong> before storing and emitting them.</p>

  <h2>Backend</h2>
  <ul>
    <li><code>LogExpReading.timestamp</code> uses <code>db.DateTime(timezone=True)</code>.</li>
    <li>Default: <code>datetime.now().astimezone(timezone.utc)</code>.</li>
    <li>JSON serialization emits ISO 8601 with <code>Z</code>.</li>
  </ul>

  <h2>Frontend</h2>
  <pre><code class="language-js">
new Date(tsString).toLocaleString("en-US", { timeZone: "America/Chicago" });
  </code></pre>

  <section id="quick-reference">
    <h2>üïí Quick Reference: Central ‚Üí UTC</h2>
    <table>
      <thead>
        <tr>
          <th>Central Time (CST/CDT)</th>
          <th>UTC</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>00:00 (Midnight)</td><td>06:00 UTC</td></tr>
        <tr><td>06:00</td><td>12:00 UTC</td></tr>
        <tr><td>12:00 (Noon)</td><td>18:00 UTC</td></tr>
        <tr><td>18:00</td><td>00:00 UTC (next day)</td></tr>
      </tbody>
    </table>
    <p><strong>Rule of thumb:</strong> Central is UTC‚Äë6 in winter (CST), UTC‚Äë5 in summer (CDT).</p>
  </section>

  <section id="policy">
    <h2>üåç Timestamp and Timezone Policy</h2>
    <p>LogExp normalizes all timestamps to <strong>UTC</strong> before storing and emitting them.</p>
    <h3>Backend</h3>
    <ul>
      <li><code>LogExpReading.timestamp</code> uses <code>db.DateTime(timezone=True)</code>.</li>
      <li>Default: <code>datetime.now().astimezone(timezone.utc)</code>.</li>
      <li>JSON serialization emits ISO 8601 with <code>Z</code>.</li>
    </ul>
    <h3>Frontend</h3>
    <ul>
      <li>Browser converts UTC to local automatically.</li>
      <li>Force Central display:
        <pre><code class="language-js">
new Date(tsString).toLocaleString("en-US", { timeZone: "America/Chicago" });
        </code></pre>
      </li>
    </ul>
  </section>

  <section id="troubleshooting">
    <h2>üõ† Troubleshooting Timezone Issues</h2>
    <h3>Symptom</h3>
    <ul>
      <li>JSON shows <code>"2025-12-12T10:53:42Z"</code>.</li>
      <li>Chart shows <code>04:53 CST</code> instead of <code>10:53 CST</code>.</li>
    </ul>
    <h3>Root Cause</h3>
    <p>Using <code>datetime.now(timezone.utc)</code> on a Central system clock mislabeled local time as UTC.</p>
    <h3>Fix</h3>
    <ul>
      <li>Use <code>datetime.now().astimezone(timezone.utc)</code>.</li>
      <li>Ensure <code>db.DateTime(timezone=True)</code>.</li>
      <li>Emit UTC with <code>Z</code>.</li>
    </ul>
    <h3>Regression Test</h3>
    <pre><code class="language-python">
def test_timestamp_serialization_is_utc():
    local = datetime(2025, 12, 12, 10, 30).astimezone()  # 10:30 CST
    reading = LogExpReading(timestamp=local.astimezone(timezone.utc), ...)
    data = reading.to_dict()
    assert data["timestamp"].endswith("16:30:00Z")
    </code></pre>
  </section>

  <section id="faq-timezone">
    <h2>‚ùì FAQ: Why do my charts show times six hours off?</h2>
    <p><strong>Cause:</strong> Local Central time was stamped and mislabeled as UTC.</p>
    <p><strong>Fix:</strong> Use <code>datetime.now().astimezone(timezone.utc)</code> in poller and models.</p>
    <h3>Correct Poller Code</h3>
    <pre><code class="language-python">
reading = LogExpReading(
    timestamp=datetime.now().astimezone(timezone.utc),  # convert local ‚Üí UTC
    counts_per_second=parsed["counts_per_second"],
    counts_per_minute=parsed["counts_per_minute"],
    microsieverts_per_hour=parsed["microsieverts_per_hour"],
    mode=parsed["mode"]
)
    </code></pre>
  </section>

  <section id="routing">
    <h2>üìç Routing Changes for Pager</h2>
    <p>
      The new <strong>Timezone Policy page</strong> is available under:
      <code>/docs/timezone</code>
    </p>
    <ul>
      <li>Update navigation to include <em>Timezone Policy</em> in the sidebar.</li>
      <li>Add a redirect from <code>/docs/troubleshooting/timezone</code> ‚Üí <code>/docs/timezone</code>.</li>
      <li>Ensure pager links (<code>Next</code>/<code>Previous</code>) route correctly:
        <ul>
          <li><code>Previous</code> ‚Üí <em>Data Model</em> page.</li>
          <li><code>Next</code> ‚Üí <em>Frontend Integration</em> page.</li>
        </ul>
      </li>
    </ul>
    <p>
      This ensures contributors can reach the Timezone Policy page directly from both troubleshooting and FAQ contexts.
    </p>
  </section>
{% endblock %}

{% block pager %}
  <a href="{{ url_for('docs.docs_index') }}" class="prev">‚Üê Docs Index</a>
  <a href="{{ url_for('docs.docs_index') }}" class="next">Frontend Integration ‚Üí</a>
{% endblock %}
