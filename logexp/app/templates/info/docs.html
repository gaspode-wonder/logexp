{% extends "base.html" %}

{% block title %}Documentation - LogExp{% endblock %}

{% block content %}
  <h1>Documentation Index</h1>
  <p>Welcome to the LogExp documentation hub. This guide covers setup, architecture, endpoints, and hardware integration.</p>

  <h2>Quickstart</h2>
  <ul>
    <li>Clone the repository and install dependencies:
      <pre><code>pip install -r requirements.txt</code></pre>
    </li>

    <li>Configure your environment:
      <pre><code>export SQLALCHEMY_DATABASE_URI=postgresql://user:pass@localhost:5432/logexp</code></pre>
    </li>

    <li>Initialize the database:
      <pre><code>flask db upgrade</code></pre>
    </li>

    <li>Run the development server:
      <pre><code>flask run</code></pre>
    </li>

    <li>Run the production Docker stack:
      <pre><code>docker compose up --build</code></pre>
    </li>
  </ul>

  <h2>Docker Deployment</h2>
  <p>LogExp ships with a production‑ready Docker configuration:</p>
  <ul>
    <li>Gunicorn application server (1 worker, thread‑safe for poller)</li>
    <li>Automatic Alembic migrations on startup</li>
    <li>Idempotent database seeding via <code>flask seed-data</code></li>
    <li>Poller disabled by default inside containers (<code>START_POLLER=False</code>)</li>
  </ul>

  <h2>Endpoints</h2>
  <ul>
    <li><code>/readings</code> → Web UI table + chart</li>
    <li><code>/api/readings.json</code> → JSON of stored readings</li>
    <li><code>/api/readings.csv</code> → CSV export (UI + API)</li>
    <li><code>/api/poller/status</code> → Poller health</li>
    <li><code>/api/poller/start</code> → Start poller (host mode only)</li>
    <li><code>/api/poller/stop</code> → Stop poller</li>
    <li><code>/api/geiger/test</code> → Hardware diagnostic</li>
    <li><code>/api/health</code> → Application healthcheck</li>
  </ul>

  <h2>Poller Lifecycle</h2>
  <p>
    The Geiger poller runs as a background thread and reads from a USB‑serial device.
    In Docker, the poller is disabled by default to avoid missing hardware devices.
    Enable it explicitly with:
  </p>
  <pre><code>START_POLLER=True</code></pre>
  <p>
    Control the poller via API or CLI:
  </p>
  <pre><code>flask geiger-start
flask geiger-stop</code></pre>

  <h2>Timezone Handling</h2>
  <p>
    All readings are stored in UTC. The UI renders timestamps in
    <code>America/Chicago</code> by default using a 24‑hour clock.
  </p>

  <h2>Troubleshooting</h2>
  <ul>
    <li><strong>Poller errors in Docker</strong>: Ensure <code>START_POLLER=False</code> unless USB devices are passed through.</li>
    <li><strong>Alembic issues</strong>: Reset the <code>alembic_version</code> table and rerun migrations.</li>
    <li><strong>Port conflicts</strong>: macOS Control Center may occupy port 5000; disable AirPlay Receiver.</li>
    <li><strong>500 errors on index</strong>: Verify blueprint names and endpoint references.</li>
  </ul>

  <h2>Hardware: MightyOhm Geiger Counter</h2>
  <p>
    LogExp integrates with the
    <a href="https://mightyohm.com/blog/products/geiger-counter/" target="_blank">
      MightyOhm Geiger Counter
    </a>, a DIY radiation detector with USB‑serial output.
  </p>
  <ul>
    <li>USB‑serial interface</li>
    <li>Counts per second/minute</li>
    <li>Microsieverts/hour</li>
    <li>Open hardware design</li>
  </ul>

  <h2>System Diagram</h2>
  <pre>
  [MightyOhm Geiger Counter]
              │ USB-Serial
              ▼
        [LogExp Poller Thread]
              │
              ▼
        [Postgres Database]
              │
              ▼
        [Flask API Endpoints]
              │
              ▼
        [Web UI / Clients]
  </pre>

  <h2>Sample Reading Output</h2>
  <p>Example JSON from <code>/api/readings.json</code>:</p>
  <pre>
  [
    {
      "id": 1,
      "timestamp": "2025-12-09T17:30:00Z",
      "counts_per_second": 0.7,
      "counts_per_minute": 42,
      "microsieverts_per_hour": 0.12,
      "mode": "normal"
    }
  ]
  </pre>
{% endblock %}

{% block pager %}
  <a href="{{ url_for('routes_ui.readings_index') }}" class="prev">← Readings</a>
  <a href="{{ url_for('info.info_about') }}" class="next">About →</a>
{% endblock %}
